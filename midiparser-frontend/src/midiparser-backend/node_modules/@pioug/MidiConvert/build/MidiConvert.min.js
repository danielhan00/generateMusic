'use strict';var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,e,f){if(f.get||f.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[e]=f.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global?global:b};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,e,f,p){if(e){f=$jscomp.global;b=b.split(".");for(p=0;p<b.length-1;p++){var l=b[p];l in f||(f[l]={});f=f[l]}b=b[b.length-1];p=f[b];e=e(p);e!=p&&null!=e&&$jscomp.defineProperty(f,b,{configurable:!0,writable:!0,value:e})}};$jscomp.polyfill("Math.log2",function(b){return b?b:function(b){return Math.log(b)/Math.LN2}},"es6-impl","es3");
$jscomp.checkStringArgs=function(b,e,f){if(null==b)throw new TypeError("The 'this' value for String.prototype."+f+" must not be null or undefined");if(e instanceof RegExp)throw new TypeError("First argument to String.prototype."+f+" must not be a regular expression");return b+""};$jscomp.polyfill("String.prototype.includes",function(b){return b?b:function(b,f){return-1!==$jscomp.checkStringArgs(this,b,"includes").indexOf(b,f||0)}},"es6-impl","es3");
$jscomp.findInternal=function(b,e,f){b instanceof String&&(b=String(b));for(var p=b.length,l=0;l<p;l++){var r=b[l];if(e.call(f,r,l,b))return{i:l,v:r}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,f){return $jscomp.findInternal(this,b,f).v}},"es6-impl","es3");$jscomp.owns=function(b,e){return Object.prototype.hasOwnProperty.call(b,e)};
$jscomp.polyfill("Object.assign",function(b){return b?b:function(b,f){for(var e=1;e<arguments.length;e++){var l=arguments[e];if(l)for(var r in l)$jscomp.owns(l,r)&&(b[r]=l[r])}return b}},"es6-impl","es3");
(function(b,e){"object"===typeof exports&&"undefined"!==typeof module?e(exports):"function"===typeof define&&define.amd?define(["exports"],e):e(b.MidiConvert=b.MidiConvert||{})})(this,function(b){function e(a){a=/([A-G])(#+|b+)?([0-9]+)$/i.exec(a);var c=a[1].toUpperCase(),b=a[2]||"";return 12*parseInt(a[3],10)+B[c]+("#"===b.substr(0,1)?1:-1)*b.length}function f(a){return"number"!==typeof a&&/[^0-9]/.test(a)?e(a):parseInt(a,10)}function p(a,c){var b=0,d=a;23<a&&(b=Math.floor(a/12)-1,d=a-12*b);a=C[d];
c&&0<a.indexOf("#")&&(a=D[a]);return a+b}function l(a){a=Math.floor(6E7/a);var c=[];do c.unshift(a&255),a>>=8;while(a);for(;3>c.length;)c.push(0);return c}function r(a){return String.fromCharCode.apply(null,a)}function x(a,c){if(c)for(;a.length/2<c;)a="0"+a;c=[];var b,d;for(d=a.length-1;0<=d;d-=2)b=0===d?a[d]:a[d-1]+a[d],c.unshift(parseInt(b,16));return c}function y(a){var c=a&127,b=!0,d=[];for(a>>=7;a;)c<<=8,c|=a&127|128,a>>=7;for(;b;)d.push(c&255),c&128?c>>=8:b=!1;return d}function z(a){var c=[],
b;for(b in a)a.hasOwnProperty(b)&&c.push(a[b]);return c}function E(a,c){return a.concat(c)}function F(a){return!!a}function G(a,c){if(c.name.includes("Note"))a["add"+c.name](0,c.midiNote,c.deltaTime,127*c.velocity);else if(c.name.includes("Sustain"))a["add"+c.name](0,c.deltaTime);return a}function H(a,c,b,d){var m=a[a.length-1],g=c;if(!a.length)return g.taken=!0,[g];g=d.find(function(a){return!a.taken&&a.time>=m.time});c=a.filter(function(a){return a.midiNote===g.midiNote}).pop();if(!c)return g.taken=
!0,a.concat(g);d=d.filter(function(a){return!a.taken&&a.time===g.time});c&&c.name.includes("On")?g=d.find(function(a){return a.name.includes("Off")})||g:c&&c.name.includes("Off")&&(g=d.find(function(a){return a.name.includes("On")})||g);g.taken=!0;return a.concat(g)}function I(a,c){return a.time-c.time}function J(a){if("undefined"!==typeof a.midiNote)return[{duration:parseInt(a.duration),midiNote:a.midiNote,name:"NoteOn",time:parseInt(a.time),velocity:a.velocity},{duration:parseInt(a.duration),midiNote:a.midiNote,
name:"NoteOff",time:parseInt(a.time)+parseInt(a.duration),velocity:a.velocity}];if("sustain"===a.eventName)return[{name:"SustainOn",time:parseInt(a.time)},{name:"SustainOff",time:parseInt(a.time)+parseInt(a.duration)}]}function K(a,c,b,d){return a.concat({duration:c.duration,time:c.time,name:c.name,midiNote:c.midiNote,deltaTime:0!==a.length?c.time-d[b-1].time:c.time,velocity:c.velocity})}function A(a){function c(c){var d=a.charCodeAt(b);c&&127<d&&(d-=256);b+=1;return d}var b=0;return{eof:function(){return b>=
a.length},read:function(c){var d=a.substr(b,c);b+=c;return d},readInt32:function(){var c=(a.charCodeAt(b)<<24)+(a.charCodeAt(b+1)<<16)+(a.charCodeAt(b+2)<<8)+a.charCodeAt(b+3);b+=4;return c},readInt16:function(){var c=(a.charCodeAt(b)<<8)+a.charCodeAt(b+1);b+=2;return c},readInt8:c,readVarInt:function(){for(var a=0,b=c();b&128;)a+=b&127,a<<=7,b=c();return a+b}}}function L(a){function c(a){var c=a.read(4),b=a.readInt32();return{id:c,length:b,data:a.read(b)}}function b(a){var c={deltaTime:a.readVarInt()},
b=a.readInt8(),m;if(240===(b&240)){if(255===b)switch(c.type="meta",c.subtype=a.readInt8(),b=a.readVarInt(),c.subtype){case k.COPYRIGHT_NOTICE:case k.CUE_POINT:case k.INSTRUMENT_NAME:case k.LYRICS:case k.MARKER:case k.SEQUENCER_SPECIFIC:case k.TEXT:case k.TRACK_NAME:return c.text=a.read(b),c;case k.SEQUENCE_NUMBER:if(2!==b)throw"Expected length for sequenceNumber event is 2, got "+b;c.number=a.readInt16();return c;case k.MIDI_CHANNEL_PREFIX:if(1!==b)throw"Expected length for midiChannelPrefix event is 1, got "+
b;c.channel=a.readInt8();return c;case k.END_OF_TRACK:if(0!==b)throw"Expected length for endOfTrack event is 0, got "+b;return c;case k.SET_TEMPO:if(3!==b)throw"Expected length for setTempo event is 3, got "+b;c.microsecondsPerBeat=(a.readInt8()<<16)+(a.readInt8()<<8)+a.readInt8();return c;case k.SMPTE_OFFSET:if(5!==b)throw"Expected length for smpteOffset event is 5, got "+b;b=a.readInt8();c.frameRate={0:24,32:25,64:29,96:30}[b&96];c.hour=b&31;c.min=a.readInt8();c.sec=a.readInt8();c.frame=a.readInt8();
c.subframe=a.readInt8();return c;case k.TIME_SIGNATURE:if(4!==b)throw"Expected length for timeSignature event is 4, got "+b;c.numerator=a.readInt8();c.denominator=Math.pow(2,a.readInt8());c.metronome=a.readInt8();c.thirtyseconds=a.readInt8();return c;case k.KEY_SIGNATURE:if(2!==b)throw"Expected length for keySignature event is 2, got "+b;c.key=a.readInt8(!0);c.scale=a.readInt8();return c;default:return c.subtype="unknown",c.data=a.read(b),c}else{if(240===b)return c.type="sysEx",b=a.readVarInt(),c.data=
a.read(b),c;if(247===b)return c.type="dividedSysEx",b=a.readVarInt(),c.data=a.read(b),c}throw"Unrecognised MIDI event type byte: "+b;}0===(b&128)?(m=b,b=d):(m=a.readInt8(),d=b);c.subtype=b&240;c.channel=b&15;c.type="channel";switch(c.subtype){case h.NOTE_OFF:return c.noteNumber=m,c.velocity=a.readInt8(),c;case h.NOTE_ON:return c.noteNumber=m,c.velocity=a.readInt8(),c.subtype=0===c.velocity?h.NOTE_OFF:h.NOTE_ON,c;case h.AFTER_TOUCH:return c.noteNumber=m,c.amount=a.readInt8(),c;case h.CONTROL_CHANGE:return c.controllerType=
m,c.value=a.readInt8(),c;case h.PROGRAM_CHANGE:return c.programNumber=m,c;case h.CHANNEL_AFTERTOUCH:return c.amount=m,c;case h.PITCH_BEND:return c.value=m+(a.readInt8()<<7),c;default:throw"Unrecognised MIDI event type: undefined";}}var d;a=A(a);var v=c(a),g=[],e,f,w,u,l;if("MThd"!==v.id||6!==v.length)throw"Bad .mid file - header not found";e=A(v.data);v=e.readInt16();f=e.readInt16();e=e.readInt16();if(e&32768)throw"Expressing time division in SMTPE frames is not supported yet";for(w=0;w<f;w++){g[w]=
[];u=c(a);if("MTrk"!==u.id)throw"Unexpected chunk - expected MTrk, got "+u.id;for(u=A(u.data);!u.eof();)l=b(u),g[w].push(l)}return{header:{formatType:v,trackCount:f,ticksPerBeat:e},tracks:g}}function M(a,c){c=Object.assign({deterministic:!1,duration:!0,noteName:!0,PPQ:128},c);return a.tracks.reduce(function(b,d){function m(b){b.time=(Math.round(b.time/a.header.ticksPerBeat*c.PPQ)||0)+"i";b.duration=(Math.round(b.duration/a.header.ticksPerBeat*c.PPQ)||0)+"i";return b}var g=0,e=!1;d=d.reduce(function(a,
b){var d;g+=b.deltaTime;switch(!0){case b.subtype===h.NOTE_ON:if(d=a.filter(function(a){return a.midiNote===b.noteNumber&&"undefined"===typeof a.duration}).pop())d.duration=g-d.time;d={time:g,midiNote:b.noteNumber,velocity:b.velocity/127};c.noteName&&(d.noteName=p(b.noteNumber));return a.concat(d);case b.subtype===h.NOTE_OFF:if(d=a.filter(function(a){return a.midiNote===b.noteNumber&&"undefined"===typeof a.duration}).pop())d.duration=g-d.time;return a;case b.controllerType===h.CONTROLLER.DAMPER_PEDAL&&
64<=b.value&&!e:return d={eventName:"sustain",time:g},e=!0,a.concat(d);case b.controllerType===h.CONTROLLER.DAMPER_PEDAL&&64>b.value&&e:if(d=a.filter(function(a){return"sustain"===a.eventName&&"undefined"===typeof a.duration}).pop())d.duration=g-d.time;e=!1;return a;default:return a}},[]).filter(function(a,c,b){return!b.find(function(c){return c!==a&&c.midiNote===a.midiNote&&c.time===a.time&&c.duration>a.duration})});c.duration&&(d=d.map(m));c.deterministic&&(d=d.sort(N));return 0===d.length?b:b.concat([d])},
[])}function N(a,c){var b=parseInt(a.time)-parseInt(c.time),d=a.midiNote&&c.midiNote&&a.midiNote-c.midiNote,e=parseInt(c.duration)-parseInt(a.duration);a=c.velocity-a.velocity;return b||d||e||a}function O(a,c,b){var d=c.filter(function(a){return a.subtype===k.TRACK_NAME}).pop();c=c.filter(function(a){return a.subtype===h.NOTE_ON}).length;d&&c&&(a[b]=d.text.replace(/\u0000/g,""));return a}function P(a,c){(c=c.filter(function(a){return a.subtype===h.PROGRAM_CHANGE}).pop())&&(a[c.channel]=9===c.channel?
0:c.programNumber+1);return a}function Q(a){return(a=a.filter(function(a){return a.subtype===k.TIME_SIGNATURE}).pop())?[a.numerator,a.denominator]:null}function R(a){return(a=a.filter(function(a){return a.subtype===k.SET_TEMPO}).pop())?6E7/a.microsecondsPerBeat:null}function S(a){var c=0;a=a.reduce(function(a,b){var d=b.channel||0,m;a[d]=a[d]||[];m=a[d][a[d].length-1];a[d].push(b);c+=b.deltaTime;b.absoluteTime=c;b.deltaTime=m?b.absoluteTime-m.absoluteTime:b.absoluteTime;return a},{});return z(a)}
var h={NOTE_OFF:128,NOTE_ON:144,AFTER_TOUCH:160,CONTROL_CHANGE:176,CONTROLLER:{DAMPER_PEDAL:64},PROGRAM_CHANGE:192,CHANNEL_AFTERTOUCH:208,PITCH_BEND:224},k={SEQUENCE_NUMBER:0,TEXT:1,COPYRIGHT_NOTICE:2,TRACK_NAME:3,INSTRUMENT_NAME:4,LYRICS:5,MARKER:6,CUE_POINT:7,PROGRAM_NAME:8,DEVICE_NAME:9,MIDI_CHANNEL_PREFIX:32,MIDI_PORT:33,END_OF_TRACK:47,SET_TEMPO:81,SMPTE_OFFSET:84,TIME_SIGNATURE:88,KEY_SIGNATURE:89,SEQUENCER_SPECIFIC:127},D={"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab"},B={A:21,B:23,C:12,
D:14,E:16,F:17,G:19},C={12:"C",13:"C#",14:"D",15:"D#",16:"E",17:"F",18:"F#",19:"G",20:"G#",21:"A",22:"A#",23:"B"},t=function(a){if(!this)return new t(a);this.setTime(a.time);this.setType(a.type);this.setData(a.data)};t.prototype.setTime=function(a){this.time=y(a||0)};t.prototype.setType=function(a){this.type=a};t.prototype.setData=function(a){this.data=a};t.prototype.toBytes=function(){if(!this.type)throw Error("Type for meta-event not specified.");var a=[],c;a.push.apply(a,this.time);a.push(255,
this.type);Array.isArray(this.data)?(a.push(this.data.length),a.push.apply(a,this.data)):"number"===typeof this.data?a.push(1,this.data):null!==this.data&&"undefined"!==typeof this.data?(a.push(this.data.length),c=this.data.split("").map(function(a){return a.charCodeAt(0)}),a.push.apply(a,c)):a.push(0);return a};var q=function(a){if(!this)return new q(a);!a||null===a.type&&"undefined"===typeof a.type||null===a.channel&&"undefined"===typeof a.channel||null===a.param1&&"undefined"===typeof a.param1||
(this.setTime(a.time),this.setType(a.type),this.setChannel(a.channel),this.setParam1(a.param1),this.setParam2(a.param2))};q.prototype.setTime=function(a){this.time=y(a||0)};q.prototype.setType=function(a){if(a<h.NOTE_OFF||a>h.PITCH_BEND)throw Error("Trying to set an unknown event: "+a);this.type=a};q.prototype.setChannel=function(a){if(0>a||15<a)throw Error("Channel is out of bounds.");this.channel=a};q.prototype.setParam1=function(a){this.param1=a};q.prototype.setParam2=function(a){this.param2=a};
q.prototype.toBytes=function(){var a=[],c=this.type|this.channel&15;a.push.apply(a,this.time);a.push(c);a.push(this.param1);"undefined"!==typeof this.param2&&null!==this.param2&&a.push(this.param2);return a};b.Track=function(a){if(!this)return new b.Track(a);this.events=(a||{}).events||[]};b.Track.START_BYTES=[77,84,114,107];b.Track.END_BYTES=[0,255,47,0];b.Track.prototype.addEvent=function(a){this.events.push(a);return this};b.Track.prototype.addNoteOn=function(a,c,b,d){this.events.push(new q({type:h.NOTE_ON,
channel:a,param1:f(c),param2:d||90,time:b||0}));return this};b.Track.prototype.addNoteOff=function(a,c,b,d){this.events.push(new q({type:h.NOTE_OFF,channel:a,param1:f(c),param2:d||90,time:b||0}));return this};b.Track.prototype.addSustainOn=function(a,c){this.events.push(new q({type:h.CONTROL_CHANGE,channel:a,param1:h.CONTROLLER.DAMPER_PEDAL,param2:127,time:c||0}));return this};b.Track.prototype.addSustainOff=function(a,c){this.events.push(new q({type:h.CONTROL_CHANGE,channel:a,param1:h.CONTROLLER.DAMPER_PEDAL,
param2:0,time:c||0}));return this};b.Track.prototype.addNote=function(a,c,b,d,e){this.noteOn(a,c,d,e);b&&this.noteOff(a,c,b,e);return this};b.Track.prototype.addChord=function(a,c,b,d){if(!Array.isArray(c)&&!c.length)throw Error("Chord must be an array of pitches");c.forEach(function(c){this.noteOn(a,c,0,d)},this);c.forEach(function(c,d){0===d?this.noteOff(a,c,b):this.noteOff(a,c)},this);return this};b.Track.prototype.setInstrument=function(a,c,b){this.events.push(new q({type:h.PROGRAM_CHANGE,channel:a,
param1:c,time:b||0}));return this};b.Track.prototype.setTimeSignature=function(a,c,b){this.events.push(new t({type:k.TIME_SIGNATURE,data:[a,Math.log2(c),24,8],time:b||0}));return this};b.Track.prototype.setTempo=function(a,c){this.events.push(new t({type:k.SET_TEMPO,data:l(a),time:c||0}));return this};b.Track.prototype.setName=function(a,c){this.events.push(new t({type:k.TRACK_NAME,data:a,time:c||0}));return this};b.Track.prototype.toBytes=function(){var a=0,c=[],e,d=b.Track.START_BYTES,f=b.Track.END_BYTES;
this.events.forEach(function(b){b=b.toBytes();a+=b.length;c.push.apply(c,b)});a+=f.length;e=x(a.toString(16),4);return d.concat(e,c,f)};var n=function(a){if(!this)return new n(a);a=a||{};if(a.ticks){if("number"!==typeof a.ticks)throw Error("Ticks per beat must be a number!");if(0>=a.ticks||32768<=a.ticks||0!==a.ticks%1)throw Error("Ticks per beat must be an integer between 1 and 32767!");}this.ticks=a.ticks||128;this.tracks=a.tracks||[]};n.HDR_CHUNKID="MThd";n.HDR_CHUNK_SIZE="\x00\x00\x00\u0006";
n.HDR_TYPE0="\x00\x00";n.HDR_TYPE1="\x00\u0001";n.prototype.addTrack=function(a){if(a)return this.tracks.push(a),this;a=new b.Track;this.tracks.push(a);return a};n.prototype.toBytes=function(){var a=this.tracks.length.toString(16),b=n.HDR_CHUNKID+n.HDR_CHUNK_SIZE,b=1<parseInt(a,16)?b+n.HDR_TYPE1:b+n.HDR_TYPE0,b=b+r(x(a,2)),b=b+String.fromCharCode(this.ticks/256,this.ticks%256);this.tracks.forEach(function(a){b+=r(a.toBytes())});return b};b.generate=function(a){var b=new n;a.parts.forEach(function(c,
d){var e=b.addTrack();a.transport.bpm&&e.setTempo(a.transport.bpm);a.transport.instruments&&"undefined"!==typeof a.transport.instruments[d]&&e.setInstrument(0===a.transport.instruments[d]?9:9<=d?d+1:d,a.transport.instruments[d]-1);a.transport.timeSignature&&e.setTimeSignature(a.transport.timeSignature[0],a.transport.timeSignature[1]);a.transport.trackNames&&a.transport.trackNames[d]&&e.setName(a.transport.trackNames[d]);c.map(J).filter(F).reduce(E,[]).sort(I).reduce(H,[]).reduce(K,[]).reduce(G,e)});
return b.toBytes()};b.parse=function(a,b){a=L(a);0===a.header.formatType&&(a.tracks=S(a.tracks[0]));b=M(a,b);var c=a.tracks.reduce(E,[]),d=a.tracks.reduce(P,{});a=a.tracks.reduce(O,{});a={bpm:R(c),instruments:z(d),timeSignature:Q(c),trackNames:z(a)};return{parts:b,transport:a}};b.File=n;b.bpmFromMpqn=function(a){return Math.floor(6E7/a)};b.codes2Str=r;b.ensureMidiPitch=f;b.midiPitchFromNote=e;b.mpqnFromBpm=l;b.noteFromMidiPitch=p;b.secondsToTicks=function(a,b,e){return Math.ceil(a/60*b*(void 0===
e?128:e))};b.str2Bytes=x;b.ticksToSeconds=function(a,b,e){return 60/b*a/(void 0===e?128:e)};b.translateTickTime=y;b.midiFlattenedNotes=D;b.midiLetterPitches=B;b.midiPitchesLetter=C;Object.defineProperty(b,"__esModule",{value:!0})});
